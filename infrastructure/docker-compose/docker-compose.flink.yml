services:
  flink-jobmanager:
    build:
      context: ../../services/flink-processor
      dockerfile: Dockerfile
    hostname: flink-jobmanager
    container_name: flink-jobmanager
    ports:
      - "8082:8081"
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        jobmanager.memory.process.size: 1024m
        state.backend: hashmap
        execution.checkpointing.interval: 60000ms
        execution.checkpointing.mode: AT_LEAST_ONCE
      KAFKA_BOOTSTRAP_SERVERS: "kafka-broker-1:29092"
      REFERENCE_DATA_PATH: "/opt/flink-processor/data/reference/symbols.json"
    command: jobmanager
    networks:
      - de-network
    depends_on:
      kafka-broker-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/overview"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - flink

  flink-taskmanager:
    build:
      context: ../../services/flink-processor
      dockerfile: Dockerfile
    hostname: flink-taskmanager
    container_name: flink-taskmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
        taskmanager.memory.process.size: 1024m
        state.backend: hashmap
      KAFKA_BOOTSTRAP_SERVERS: "kafka-broker-1:29092"
      REFERENCE_DATA_PATH: "/opt/flink-processor/data/reference/symbols.json"
    command: taskmanager
    depends_on:
      flink-jobmanager:
        condition: service_healthy
    networks:
      - de-network
    profiles:
      - flink
