services:
  de-stock:
    build:
      context: ../../services/de-stock
      dockerfile: Dockerfile
    hostname: de-stock
    container_name: de-stock
    ports:
      - "8765:8765"
    volumes:
      - ../../services/de-stock/config/default.toml:/etc/de-stock/default.toml:ro
    networks:
      - de-network
    healthcheck:
      test: ["CMD-SHELL", "echo | nc -w1 localhost 8765 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  kafka-bridge:
    build:
      context: ../..
      dockerfile: services/kafka-bridge/Dockerfile
    hostname: kafka-bridge
    container_name: kafka-bridge
    environment:
      KAFKA_BRIDGE_WS_URI: ws://de-stock:8765
      KAFKA_BRIDGE_KAFKA_BOOTSTRAP_SERVERS: kafka-broker-1:29092
      KAFKA_BRIDGE_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      KAFKA_BRIDGE_LOG_LEVEL: INFO
    ports:
      - "9090:9090"
    networks:
      - de-network
    depends_on:
      de-stock:
        condition: service_healthy
      kafka-broker-1:
        condition: service_healthy
      schema-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:9090\")'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  lakehouse:
    build:
      context: ../..
      dockerfile: services/lakehouse/Dockerfile
    hostname: lakehouse
    container_name: lakehouse
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka-broker-1:29092
      ICEBERG_CATALOG_URI: http://iceberg-rest:8181
      S3_ENDPOINT: http://minio:9000
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      AWS_REGION: us-east-1
    networks:
      - de-network
    depends_on:
      kafka-broker-1:
        condition: service_healthy
      iceberg-rest:
        condition: service_started
      minio:
        condition: service_started
    restart: unless-stopped
