name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Lint ──────────────────────────────────────────────────────────────────
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff==0.9.10

      - name: Check formatting
        run: ruff format --check .

      - name: Check linting
        run: ruff check .

  # ── Common library ────────────────────────────────────────────────────────
  test-common:
    name: Tests / libs/common
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -e "libs/common[dev]"

      - name: Run tests
        run: pytest libs/common/tests -v --tb=short

  # ── Kafka Bridge ──────────────────────────────────────────────────────────
  test-kafka-bridge:
    name: Tests / kafka-bridge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/kafka-bridge[dev]"

      - name: Run tests
        run: pytest services/kafka-bridge/tests -v --tb=short

  # ── Lakehouse ─────────────────────────────────────────────────────────────
  test-lakehouse:
    name: Tests / lakehouse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/lakehouse[dev]"

      - name: Run tests
        run: pytest services/lakehouse/tests -v --tb=short

  # ── Flink Processor ───────────────────────────────────────────────────────
  test-flink:
    name: Tests / flink-processor
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/flink-processor[dev]"

      - name: Run tests
        run: pytest services/flink-processor/tests -v --tb=short

  # ── GraphQL API ───────────────────────────────────────────────────────────
  test-graphql-api:
    name: Tests / graphql-api
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/lakehouse"
          pip install -e "services/graphql-api[dev]"

      - name: Run tests
        run: pytest services/graphql-api/tests -v --tb=short

  # ── Data Quality ──────────────────────────────────────────────────────────
  test-data-quality:
    name: Tests / data-quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/lakehouse"
          pip install -e "services/data-quality[dev]"

      - name: Run tests
        run: pytest services/data-quality/tests -v --tb=short

  # ── Dagster Orchestrator ──────────────────────────────────────────────────
  test-dagster:
    name: Tests / dagster-orchestrator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Dagster requires Python 3.11 (incompatible with 3.14+)
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/lakehouse"
          pip install -e "services/data-quality"
          pip install -e "services/dagster-orchestrator[dev]"

      - name: Run tests
        run: pytest services/dagster-orchestrator/tests -v --tb=short

  # ── Superset tests ────────────────────────────────────────────────────────
  test-superset:
    name: Tests / superset
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install duckdb pytest

      - name: Run tests
        working-directory: services/superset
        run: pytest tests -v --tb=short

  # ── End-to-End pipeline tests ─────────────────────────────────────────────
  test-e2e:
    name: Tests / e2e pipeline
    runs-on: ubuntu-latest
    needs: [test-common, test-kafka-bridge, test-lakehouse]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install all service dependencies
        run: |
          pip install -e "libs/common"
          pip install -e "services/kafka-bridge"
          pip install -e "services/lakehouse"
          pip install -e "services/graphql-api"
          pip install -e "services/data-quality"
          pip install duckdb pytz pytest pytest-asyncio strawberry-graphql[fastapi] fastapi pyarrow websockets

      - name: Run e2e tests
        run: pytest tests/e2e -v --tb=short -m "not integration"

  # ── CI gate (all tests must pass) ─────────────────────────────────────────
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    needs:
      - lint
      - test-common
      - test-kafka-bridge
      - test-lakehouse
      - test-flink
      - test-graphql-api
      - test-data-quality
      - test-dagster
      - test-superset
      - test-e2e
    steps:
      - name: All checks passed
        run: echo "All CI checks passed ✓"
